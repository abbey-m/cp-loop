<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>cp loop status</title>
  <meta name="description" content="Tiny site that checks New York City's weather right now and tells you what to wear for a bike ride." />
  <meta name="theme-color" content="#FAF7F2" />
  <meta property="og:title" content="cp loop status" />
  <meta property="og:description" content="What to wear for a NYC bike ride — live temp, wind, and sunlight." />
  <style>
    /* Icon helpers */
    .icon { display:inline-block; width:12px; height:12px; margin-right:4px; vertical-align:-2px; }
    .icon svg { width:12px; height:12px; display:block; }
    .icon svg * { vector-effect: non-scaling-stroke; }

    /* ===== Typography */
    @font-face {
      font-family: 'Canela';
      src: url('./Canela-Regular.woff2') format('woff2'),
           url('./Canela-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --bg: #FAF7F2;
      --ink-900: #111827; /* neutral-900 */
      --ink-700: #374151; /* neutral-700 */
      --ink-500: #6b7280; /* neutral-500 */
      --line: rgba(17,24,39,.06);
      --card: #ffffffcc;
      --radius: 18px;
      --shadow: 0 6px 20px rgba(0,0,0,0.05);
      /* chips */
      --chip-bg: rgba(255,255,255,.70);
      --chip-border: var(--line);
      --chip-text: var(--ink-700);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0b0c;
        --ink-900: rgba(255,255,255,.88);
        --ink-700: rgba(255,255,255,.72);
        --ink-500: rgba(255,255,255,.56);
        --line: rgba(255,255,255,.10);
        --card: rgba(255,255,255,.06);
        --shadow: 0 10px 28px rgba(0,0,0,.45);
        /* chips */
        --chip-bg: rgba(255,255,255,.10);
        --chip-border: rgba(255,255,255,.16);
        --chip-text: rgba(255,255,255,.85);
      }
    }

    html, body { height: 100%; }

    body {
      margin: 0; background: var(--bg); color: var(--ink-900);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, system-ui, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      letter-spacing: 0.2px;
    }
    body.night { background: #0b0b0c; color: var(--ink-900); }

    .wrap { min-height: 100%; display: grid; place-items: center; padding: 32px; }

    .card {
      width: 100%; max-width: 820px; background: var(--card);
      border: 1px solid var(--line); border-radius: var(--radius);
      box-shadow: var(--shadow); backdrop-filter: blur(6px);
      padding: 24px 24px 20px;
    }

    header {
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
      border-bottom: 1px solid var(--line); padding-bottom: 16px; margin-bottom: 16px;
    }

    h1 { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, system-ui, sans-serif; font-size: clamp(28px, 3.2vw, 36px); line-height: 1.05; margin: 0; color: var(--ink-900); }
    .when { font-size: 14px; color: var(--ink-500); white-space: nowrap; }

    /* Layout: two columns with matched bottoms */
    .grid { display: grid; gap: 16px; }
    @media (min-width: 720px) {
      .grid { grid-template-columns: 1fr 1fr; gap: 24px; align-items: stretch; }
      .leftCol, .rightCol { height: 100%; display: flex; flex-direction: column; }
      .rightCol { justify-content: space-between; }
    }
    @media (min-width: 1024px) { 
      .grid { grid-template-columns: 1.2fr 1fr; gap: 24px; }
    }

    /* Mobile tweaks */
    @media (max-width: 480px) {
      .wrap { padding: 16px; }
      .card { padding: 20px 16px; }
      header { flex-direction: column; align-items: flex-start; gap: 4px; }
      .when { white-space: normal; font-size: 12px; }
      .kicker { font-size: 12px; color: var(--ink-500); text-transform: uppercase; letter-spacing: 0.12em; font-variant-caps: all-small-caps; margin-bottom: 8px; }
      .advice, .wind { font-size: 16px; }
    }

    .panel { background: none; border: none; padding: 16px; }
    .kicker { font-size: 12px; color: var(--ink-500); text-transform: uppercase; letter-spacing: 0.12em; font-variant-caps: all-small-caps; margin-bottom: 8px; }
    .temp { font-size: clamp(48px, 10vw, 96px); line-height: 0.95; margin: 6px 0 2px; font-variant-numeric: tabular-nums; }
    .wind { font-size: 18px; color: var(--ink-900); margin: 6px 0 0; }
    /* Feels-like chip */
    #feelslike { margin-top: 10px; }
    .feels { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--chip-border); border-radius:999px; font-size:13px; color: var(--chip-text); background: var(--chip-bg); -webkit-backdrop-filter: saturate(120%) blur(2px); backdrop-filter: saturate(120%) blur(2px); }
    
    .feels .icon { width:12px; height:12px; margin-right:2px; }
    .feels .icon svg { width:12px; height:12px; }
    .advice { font-size: clamp(18px, 2.2vw, 22px); line-height: 1.3; margin: 4px 0 0; }

    .footer {
      margin-top: 20px; border-top: 1px solid var(--line); padding-top: 14px;
      display: flex; flex-wrap: wrap; gap: 10px 16px; align-items: center; justify-content: space-between;
      font-size: 13px; color: var(--ink-500);
    }

    /* tight button cluster (always high-contrast text/icon) */
    .cluster { display: inline-flex; align-items: center; border: 1px solid var(--line); border-radius: 999px; overflow: hidden; background: #fff; box-shadow: 0 3px 12px rgba(0,0,0,.04); }
    .cluster > * { padding: 8px 12px; }
    .cluster > * + * { border-left: 1px solid var(--line); }
    .cluster .toggle { border: 0; background: transparent; box-shadow: none; color: #111827; }
    .cluster .toggle svg { color: #111827; }
    .cluster .toggle span { color: #111827; }
    .cluster .refresh { border: 0; background: transparent; box-shadow: none; }

    button.refresh {
      appearance: none; border: 1px solid var(--line); background: #fff;
      padding: 8px 12px; border-radius: 999px; cursor: pointer; font-family: inherit;
      transition: transform .05s ease, box-shadow .2s ease, background-color .2s ease;
      box-shadow: 0 3px 12px rgba(0,0,0,.04);
    }
    button.refresh:active { transform: translateY(1px); }

    /* Theme overrides (manual) */
    html.theme-dark {
      --bg: #0b0b0c;
      --ink-900: rgba(255,255,255,.88);
      --ink-700: rgba(255,255,255,.72);
      --ink-500: rgba(255,255,255,.56);
      --line: rgba(255,255,255,.10);
      --card: rgba(255,255,255,.06);
      --shadow: 0 10px 28px rgba(0,0,0,.45);
      /* chips */
      --chip-bg: rgba(255,255,255,.10);
      --chip-border: rgba(255,255,255,.16);
      --chip-text: rgba(255,255,255,.88);
    }
    html.theme-light {
      --bg: #FAF7F2;
      --ink-900: #111827;
      --ink-700: #374151;
      --ink-500: #6b7280;
      --line: rgba(17,24,39,.06);
      --card: #ffffffcc;
      --shadow: 0 6px 20px rgba(0,0,0,0.05);
      /* chips */
      --chip-bg: rgba(255,255,255,.70);
      --chip-border: var(--line);
      --chip-text: var(--ink-700);
    }

    /* Generic toggle template (not used inside cluster) */
    .toggle {
      appearance: none; border: 1px solid var(--line); background: #fff; color: inherit;
      padding: 6px 10px; border-radius: 999px; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;
    }
    .toggle:active { transform: translateY(1px); }
    .toggle svg { width:12px; height:12px; display:block; }

    /* Motion (respect reduced motion) */
    @media (prefers-reduced-motion: no-preference) {
      .tick { animation: tick .18s ease-out; }
      @keyframes tick { from { opacity:.2; transform: translateY(2px); } to { opacity:1; transform:none; } }
    }

    /* Skeleton */
    .skeleton { position: relative; background: linear-gradient(90deg, rgba(0,0,0,.06) 25%, rgba(0,0,0,.1) 37%, rgba(0,0,0,.06) 63%); background-size: 400% 100%; color: transparent; border-radius: 6px; }
    @media (prefers-color-scheme: dark) {
      .skeleton { background: linear-gradient(90deg, rgba(255,255,255,.06) 25%, rgba(255,255,255,.12) 37%, rgba(255,255,255,.06) 63%); }
    }
    .cafe a { color: inherit; text-decoration: none; border-bottom: 1px dashed var(--ink-500); }
    .art a { color: inherit; text-decoration: none; border-bottom: 1px dashed var(--ink-500); }
    .cafe .rating { color: var(--ink-500); font-size: 13px; margin-left: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>cp loop status</h1>
        <div style="display:flex; align-items:center; gap:8px;">
          <div class="when" id="when" aria-live="polite">—</div>
        </div>
      </header>

      <div class="grid">
        <div class="leftCol">
          <!-- LEFT: RIGHT NOW + WHAT TO WEAR -->
          <section class="panel now">
            <div class="kicker">RIGHT NOW</div>
            <div class="temp" id="temp" aria-live="polite">—</div>
            <div class="wind" id="feelslike" aria-live="polite"><em>—</em></div>
          </section>

          <section class="panel what">
            <div class="kicker"><span id="shirtIcon" aria-hidden="true" class="icon"><svg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' fill='currentColor' stroke='none'><path d='M16 3c1.4 0 2.7.6 3.6 1.6L21 6l-3.8 1.9-.9 2.1V21H7V10l-.9-2.1L2.4 6l1.4-1.4A5 5 0 0 1 8 3l4 2 4-2z'/></svg></span>WHAT TO WEAR</div>
            <div class="advice" id="advice" aria-live="polite">—</div>
          </section>

          <!-- LEFT: CAFE OF THE DAY -->
          <section class="panel cafe">
            <div class="kicker"><span id="cafeIcon" aria-hidden="true" class="icon"></span>CAFE OF THE DAY</div>
            <div class="advice" id="cafe" aria-live="polite">—</div>
          </section>


          <!-- LEFT: ART IN THE PARK (moved) -->
          <section class="panel art">
            <div class="kicker"><span id="artIcon" aria-hidden="true" class="icon"></span>ART IN THE PARK</div>
            <div class="advice" id="art" aria-live="polite">—</div>
          </section>
        </div>
        <div class="rightCol">
          <!-- RIGHT: SEASON + SUNLIGHT + WIND -->
          <section class="panel season">
            <div class="kicker"><span id="seasonIcon" aria-hidden="true" class="icon"></span>SEASON</div>
            <div class="advice" id="season" aria-live="polite">—</div>
          </section>

          <section class="panel sun">
            <div class="kicker"><span id="sunIcon" aria-hidden="true" class="icon"></span>SUNLIGHT</div>
            <div class="advice" id="sunlight" aria-live="polite">—</div>
          </section>

          <!-- RIGHT: NEXT HOUR PRECIP -->
          <section class="panel precip">
            <div class="kicker"><span id="precipIcon" aria-hidden="true" class="icon"></span>NEXT HOUR</div>
            <div class="advice" id="precip" aria-live="polite">—</div>
          </section>

          <section class="panel windsec">
            <div class="kicker"><span id="windIcon" aria-hidden="true" class="icon"></span>WIND</div>
            <div class="wind" id="windMain" aria-live="polite">—</div>
            <div class="wind" id="windSub" aria-live="polite"><em>—</em></div>
          </section>

          </div>
      </div>

      <div class="footer">built with data from open-meteo
        <div class="cluster">
          <button id="themeToggle" class="toggle" aria-pressed="false" title="Toggle dark mode" aria-label="Toggle dark mode"></button>
          <button class="refresh" id="refreshBtn" title="Refresh weather" aria-label="Refresh weather">refresh</button>
        </div>
      </div>
    </div>

  <script>
  // --- NYC bike wear helper (stable build) ---
  const NYC = { lat: 40.7128, lon: -74.0060 };
  const API = `https://api.open-meteo.com/v1/forecast?latitude=${NYC.lat}&longitude=${NYC.lon}&current=temperature_2m,apparent_temperature,wind_speed_10m,wind_gusts_10m&hourly=precipitation,rain,snowfall,precipitation_probability,weather_code&daily=sunrise,sunset&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America%2FNew_York`;

  // Grab elements once
  const $temp = document.getElementById('temp');
  const $windMain = document.getElementById('windMain');
  const $windSub = document.getElementById('windSub');
  const $advice = document.getElementById('advice');
  const $feelslike = document.getElementById('feelslike');
  const $when = document.getElementById('when');
  const $refresh = document.getElementById('refreshBtn');
  const $season = document.getElementById('season');
  const $sunlight = document.getElementById('sunlight');
  const $themeToggle = document.getElementById('themeToggle');
  const metaTheme = document.querySelector('meta[name="theme-color"]');
  const $precip = document.getElementById('precip');

  // --- Art data (static fallback) ---
  // Source: https://en.wikipedia.org/wiki/Public_art_in_Central_Park (curated subset)
  const ART_STATIC = [
    { name: 'alice in wonderland', url: 'https://en.wikipedia.org/wiki/Alice_in_Wonderland_(Jose_de_Creeft)', where: 'east 74th' },
    { name: 'balto', url: 'https://en.wikipedia.org/wiki/Balto_(Central_Park)', where: 'east 67th' },
    { name: 'bethesda fountain', url: 'https://en.wikipedia.org/wiki/Bethesda_Terrace_and_Fountain', where: 'mid‑park 72nd' },
    { name: 'cleopatra’s needle', url: 'https://en.wikipedia.org/wiki/Cleopatra%27s_Needle_(New_York_City)', where: 'east 81st' },
    { name: 'hans christian andersen', url: 'https://en.wikipedia.org/wiki/Hans_Christian_Andersen_(sculpture)', where: 'east 74th' },
    { name: 'literary walk statues', url: 'https://en.wikipedia.org/wiki/The_Mall_and_Literary_Walk', where: 'mid‑park 66th–72nd' },
    { name: 'imagine mosaic', url: 'https://en.wikipedia.org/wiki/Strawberry_Fields_(memorial)', where: 'west 72nd' },
    { name: 'william shakespeare', url: 'https://en.wikipedia.org/wiki/William_Shakespeare_(sculpture)', where: 'the mall' },
    { name: 'the ramble cave', url: 'https://en.wikipedia.org/wiki/The_Ramble_and_Lake', where: 'the ramble' },
    { name: 'the dairy', url: 'https://en.wikipedia.org/wiki/The_Dairy_in_Central_Park', where: 'mid‑park 65th' },
    { name: 'bow bridge', url: 'https://en.wikipedia.org/wiki/Bow_Bridge_(Central_Park)', where: 'mid‑park 74th' },
    { name: 'dakota lanterns', url: 'https://en.wikipedia.org/wiki/The_Dakota', where: 'west 72nd' }
  ];

  // ---- Cafe data (fallback) & helpers ----
  // If you want live Google Places, set window.CAFES_ENDPOINT to a JSON URL you host
  // that returns [{ name, rating, url }] for cafes near Central Park with rating >= 3.
  // Putting a Google Places API key directly on a public site is insecure.
  const CAFES_STATIC = [
    { name: 'joe coffee company', rating: 4.4, url: 'https://maps.google.com/?q=Joe+Coffee+Company+Columbus+Avenue' },
    { name: 'bluestone lane', rating: 4.3, url: 'https://maps.google.com/?q=Bluestone+Lane+2W+90th' },
    { name: 'birch coffee', rating: 4.5, url: 'https://maps.google.com/?q=Birch+Coffee+Upper+West+Side' },
    { name: 'ralph’s coffee', rating: 4.2, url: 'https://maps.google.com/?q=Ralphs+Coffee+Upper+East+Side' },
    { name: 'irving farm', rating: 4.4, url: 'https://maps.google.com/?q=Irving+Farm+79th+St' },
    { name: 'daily provisions', rating: 4.4, url: 'https://maps.google.com/?q=Daily+Provisions+UWS' },
    { name: 'le pain quotidien', rating: 3.8, url: 'https://maps.google.com/?q=Le+Pain+Quotidien+Central+Park' },
    { name: 'bluestone lane', rating: 4.3, url: 'https://maps.google.com/?q=Bluestone+Lane+Museum+Mile' },
    { name: 'seven grams caffé', rating: 4.5, url: 'https://maps.google.com/?q=Seven+Grams+Caffe+82nd' },
    { name: 'gregorys coffee', rating: 4.0, url: 'https://maps.google.com/?q=Gregorys+Coffee+Broadway+NYC' }
  ];

  function daySeed(date = new Date()){
    const y = date.getFullYear();
    const m = date.getMonth()+1; // 1..12
    const d = date.getDate();
    // simple stable hash: y*10000 + m*100 + d
    return y*10000 + m*100 + d;
  }
  function pickDaily(list, date = new Date()){
    const seed = daySeed(date);
    const eligible = list.filter(c => (typeof c.rating === 'number' ? c.rating >= 3 : true));
    if (!eligible.length) return null;
    const idx = seed % eligible.length;
    return eligible[idx];
  }

  // Icons (Linear‑style, selective fills where helpful)
  const SUN_MAX_SVG = `
    <!-- sleek sun -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="4"/>
      <line x1="12" y1="2" x2="12" y2="4"/>
      <line x1="12" y1="20" x2="12" y2="22"/>
      <line x1="2" y1="12" x2="4" y2="12"/>
      <line x1="20" y1="12" x2="22" y2="12"/>
      <line x1="4.6" y1="4.6" x2="6.1" y2="6.1"/>
      <line x1="17.9" y1="17.9" x2="19.4" y2="19.4"/>
      <line x1="4.6" y1="19.4" x2="6.1" y2="17.9"/>
      <line x1="17.9" y1="6.1" x2="19.4" y2="4.6"/>
    </svg>`;
  const SUN_HORIZON_SVG = `
    <!-- sleek sun on horizon -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 17h18"/>
      <path d="M7 17a5 5 0 0 1 10 0"/>
      <line x1="12" y1="3" x2="12" y2="5"/>
      <line x1="5" y1="8" x2="6.5" y2="9.5"/>
      <line x1="19" y1="8" x2="17.5" y2="9.5"/>
    </svg>`;
  const MOON_SVG = `
    <!-- filled moon for night (selective fill) -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="none">
      <path d="M15.5 2.6A9 9 0 1 0 21.4 14 7 7 0 0 1 15.5 2.6Z"/>
    </svg>`;
  const WIND_SVG = `
    <!-- sleek wind swooshes -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 12h10c2 0 3-1 3-3s-1-3-3-3"/>
      <path d="M3 16h8c1.6 0 2.5.9 2.5 2s-.9 2-2.5 2"/>
      <path d="M3 8h9c2 0 3-1 3-3"/>
    </svg>`;
  const NOW_SVG = `
    <!-- sleek clock -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"/>
      <path d="M12 7v5l3 2"/>
    </svg>`;
  const SEASON_SVG = `
    <!-- solid leaf (selective fill) -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="none">
      <path d="M20.5 3.5c-6.6 2.1-11 6.5-13.1 13.1-.5 1.6-.7 2.9-.8 3.8 0 .2.2.4.4.4.9-.1 2.2-.3 3.8-.8 6.6-2.1 11-6.5 13.1-13.1.1-.3 0-.6-.2-.8l-2.4-2.4c-.2-.2-.5-.3-.8-.2z"/>
    </svg>`;
  const CAFE_SVG = `
    <!-- sleek to-go cup -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 3h16l-1 4H5L4 3z"/>
      <path d="M5 7h14v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7z"/>
    </svg>`;
  const THERMO_SVG = `
    <!-- sleek thermometer -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10 14.5V5a2 2 0 1 1 4 0v9.5a4 4 0 1 1-4 0z"/>
      <line x1="12" y1="8" x2="12" y2="12"/>
    </svg>`;
  const ART_SVG = `
    <!-- sleek statue/plinth icon -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <rect x="7" y="14" width="10" height="6" rx="1"/>
      <path d="M10 14v-2a 2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"/>
      <circle cx="12" cy="7.5" r="2"/>
    </svg>`;
  const RAIN_SVG = `
    <!-- sleek cloud rain -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M6 16a4 4 0 1 1 .5-7.9A5 5 0 0 1 20 10a4 4 0 0 1-1 8H7"/>
      <path d="M8 20l1-2M12 20l1-2M16 20l1-2"/>
    </svg>`;
  const SNOW_SVG = `
    <!-- sleek cloud snow -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M6 16a4 4 0 1 1 .5-7.9A5 5 0 0 1 20 10a4 4 0 0 1-1 8H7"/>
      <path d="M9 20h0M12 20h0M15 20h0"/>
    </svg>`;
  const CLEAR_SVG = `
    <!-- sleek clear (no precip) -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="4"/>
    </svg>`;
  

  // Theme toggle support (reuse sun/moon above)
  const SUN_TOGGLE_ICON = SUN_MAX_SVG;
  const MOON_TOGGLE_ICON = MOON_SVG;

  function setTheme(mode){
    // mode: 'light' | 'dark' | 'auto'
    document.documentElement.classList.remove('theme-light','theme-dark');
    if(mode === 'light') document.documentElement.classList.add('theme-light');
    if(mode === 'dark') document.documentElement.classList.add('theme-dark');
    localStorage.setItem('themeMode', mode);

    // button label + icon
    if($themeToggle){
      if(mode === 'dark') { $themeToggle.innerHTML = `${MOON_TOGGLE_ICON}<span>dark</span>`; $themeToggle.setAttribute('aria-pressed','true'); }
      else if(mode === 'light') { $themeToggle.innerHTML = `${SUN_TOGGLE_ICON}<span>light</span>`; $themeToggle.setAttribute('aria-pressed','false'); }
      else {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        $themeToggle.innerHTML = `${prefersDark ? MOON_TOGGLE_ICON : SUN_TOGGLE_ICON}<span>auto</span>`;
        $themeToggle.setAttribute('aria-pressed','false');
      }
    }

    // meta theme-color for mobile chrome address bar
    if(metaTheme){
      const darkBG = '#0b0b0c';
      const lightBG = '#FAF7F2';
      const content = mode === 'dark' ? darkBG : (mode === 'light' ? lightBG : (window.matchMedia('(prefers-color-scheme: dark)').matches ? darkBG : lightBG));
      metaTheme.setAttribute('content', content);
    }
  }
  function getTheme(){ return localStorage.getItem('themeMode') || 'auto'; }
  function toggleTheme(){ const cur = getTheme(); setTheme(cur === 'dark' ? 'light' : 'dark'); }
  function resetAutoTheme(){ setTheme('auto'); }

  function formatWhen(date = new Date()) {
    const tz = 'America/New_York';
    const w  = new Intl.DateTimeFormat('en-US', { weekday: 'long', timeZone: tz }).format(date);
    const md = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', timeZone: tz }).format(date); // e.g., "Nov 5"
    const hm = new Intl.DateTimeFormat('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: tz }).format(date); // e.g., "12:38 AM"
    return `${w}, ${md} at ${hm}`.toLowerCase();
  }

  function windLabel(speedMph, tempF) {
    if (tempF < 30) return 'bitter';
    if (speedMph < 8) return 'light';
    if (speedMph < 16) return 'moderate';
    if (speedMph < 21) return 'breezy';
    if (speedMph < 28) return 'blustery';
    return 'gusty';
  }

  function wearAdvice(tempF) {
    if (tempF >= 70) {
      return "throw on that spf, shades, and shorts!";
    } else if (tempF >= 60) {
      return "shorts are still on the menu! add a light vest to stay warm";
    } else if (tempF >= 50) {
      return "time to cover those knees! throw on a headband and vest if you're feeling chilly";
    } else if (tempF >= 40) {
      return "bring out the thermal tights, cycling jacket, gloves, socks, a headband, and chapstick";
    } else if (tempF >= 30) {
      return "time for all the insulation including a buff for your face and beefy mittens";
    } else {
      return "this is serious business: double layers, a hefty buff, and heated gear if you have it. stay warm!";
    }
  }

  function seasonLabel(date = new Date()) {
    // Map NYC's "12 seasons" (per 12seasons.nyc) by day-of-year bands.
    // Order: winter → fool's spring → second winter → spring of deception → third winter → the pollening → actual spring → summer → hell's front porch → false fall → second summer → actual fall
    const startOfYear = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
    const doy = Math.floor((Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()) - startOfYear.getTime()) / 86400000) + 1; // 1..366
    const leap = ((date.getUTCFullYear() % 4 === 0 && date.getUTCFullYear() % 100 !== 0) || (date.getUTCFullYear() % 400 === 0));
    const last = leap ? 366 : 365;
    const inRange = (d, a, b) => d >= a && d <= b;

    if (inRange(doy, 1, 41)) return "winter";                 // Jan 1–Feb 10
    if (inRange(doy, 42, 61)) return "fool's spring";          // Feb 11–Mar 1
    if (inRange(doy, 62, 74)) return "second winter";          // Mar 2–Mar 15
    if (inRange(doy, 75, 90)) return "spring of deception";    // Mar 16–Mar 31
    if (inRange(doy, 91, 105)) return "third winter";          // Apr 1–Apr 15
    if (inRange(doy, 106, 135)) return "the pollening";        // Apr 16–May 15
    if (inRange(doy, 136, 166)) return "actual spring";        // May 16–Jun 15
    if (inRange(doy, 167, 196)) return "summer";               // Jun 16–Jul 15
    if (inRange(doy, 197, 243)) return "hell's front porch";   // Jul 16–Aug 31
    if (inRange(doy, 244, 259)) return "false fall";           // Sep 1–Sep 15
    if (inRange(doy, 260, 283)) return "second summer";        // Sep 16–Oct 10
    if (inRange(doy, 284, last)) return "actual fall";         // Oct 11–Dec 31

    return "winter"; // fallback
  }

  function parseLocalIso(isoLike) { return new Date(isoLike); }

  // Loading & micro-interactions
  function setLoading(isLoading){
    if(!$refresh) return;
    if(isLoading){
      $refresh.disabled = true;
      $refresh.dataset.label = $refresh.textContent;
      $refresh.innerHTML = `<svg class="spin" width="14" height="14" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" opacity=".2"/><path d="M18 10a8 8 0 0 0-8-8" stroke="currentColor" stroke-width="2"/></svg>`;
    } else {
      $refresh.disabled = false;
      $refresh.textContent = $refresh.dataset.label || 'refresh';
    }
  }
  function tick(el){ if(!el) return; el.classList.remove('tick'); void el.offsetWidth; el.classList.add('tick'); }

  // Precip nowcast helper (shared)
  function updatePrecipNowcast(now, htime, hrain, hsnow, hprec, hprob, hcode){
    try {
      if ($precip && Array.isArray(htime) && htime.length) {
        const hourFloor = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours());
        const idx = htime.findIndex(ts => new Date(ts) >= hourFloor);
        const curIdx = idx === -1 ? 0 : idx;
        const nextIdx = Math.min(curIdx + 1, htime.length - 1);

        const curRain = (hrain[curIdx] ?? 0) + (hprec[curIdx] ?? 0);
        const nextRain = (hrain[nextIdx] ?? 0) + (hprec[nextIdx] ?? 0);
        const curSnow = (hsnow[curIdx] ?? 0);
        const nextSnow = (hsnow[nextIdx] ?? 0);
        const curProb = (hprob[curIdx] ?? 0);
        const nextProb = (hprob[nextIdx] ?? 0);
        const curCode = (hcode[curIdx] ?? 0);
        const nextCode = (hcode[nextIdx] ?? 0);

        const isSnowCode = c => [71,73,75,77,85,86].includes(Number(c));
        const isRainCode = c => [51,53,55,56,57,61,63,65,66,67,80,81,82,95,96,99].includes(Number(c));

        const minutesToNextHour = 60 - now.getMinutes();
        const minsStr = minutesToNextHour === 60 ? 'now' : `${minutesToNextHour} minute${minutesToNextHour===1?'':'s'}`;
        const intensity = (mm) => mm >= 4 ? 'heavy ' : (mm >= 2 ? 'moderate ' : '');

        let msg = '—';
        let icon = CLEAR_SVG;

        if (curSnow > 0 || isSnowCode(curCode)) { msg = 'snowing'; icon = SNOW_SVG; }
        else if (curRain > 0 || isRainCode(curCode)) { msg = `${intensity(curRain)}raining`.trim(); icon = RAIN_SVG; }
        else if (nextSnow > 0 || (isSnowCode(nextCode) && nextProb >= 30)) { msg = `snow expected in ${minsStr}`; icon = SNOW_SVG; }
        else if (nextRain > 0 || (isRainCode(nextCode) && nextProb >= 30)) { msg = `${intensity(nextRain)}rain expected in ${minsStr}`.trim(); icon = RAIN_SVG; }
        else if (nextProb >= 30) { msg = `${nextProb}% chance of ${isSnowCode(nextCode)?'snow':'rain'} in ${minsStr}`; icon = CLEAR_SVG; }
        else { msg = 'nothing on the forecast'; icon = CLEAR_SVG; }

        $precip.textContent = msg;
        const precipIconEl2 = document.getElementById('precipIcon');
        if (precipIconEl2) precipIconEl2.innerHTML = icon;
        tick($precip);
      }
    } catch(e) { console.warn('precip nowcast failed', e); }
  }

  async function load() {
    setLoading(true);
    try {
      if ($when) $when.textContent = formatWhen();
      // skeletons
      $advice && $advice.classList.add('skeleton');
      $windMain && $windMain.classList.add('skeleton');
      $windSub && $windSub.classList.add('skeleton');

      const res = await fetch(API, { cache: 'no-store' });
      if (!res.ok) throw new Error('Weather fetch failed');
      const data = await res.json();

      const t = data?.current?.temperature_2m;
      const appTemp = data?.current?.apparent_temperature;
      const ws = data?.current?.wind_speed_10m;
      const wg = data?.current?.wind_gusts_10m;
      const sunrise = data?.daily?.sunrise?.[0];
      const sunset  = data?.daily?.sunset?.[0];
      const htime = data?.hourly?.time || [];
      const hrain = data?.hourly?.rain || [];
      const hsnow = data?.hourly?.snowfall || [];
      const hprec = data?.hourly?.precipitation || [];
      const hprob = data?.hourly?.precipitation_probability || [];
      const hcode = data?.hourly?.weather_code || [];

      if (typeof t !== 'number' || typeof ws !== 'number') {
        throw new Error('Missing current weather fields');
      }

      const roundedT = Math.round(t);
      const label = windLabel(ws, t); // already lowercase

      if ($temp) { $temp.textContent = `${roundedT}°F`; tick($temp); }
      if ($feelslike) {
        const feels = (typeof appTemp === 'number') ? Math.round(appTemp) : roundedT;
        $feelslike.innerHTML = `<span class="feels"><span class="icon">${THERMO_SVG}</span><span>feels like ${feels}°F</span></span>`;
        tick($feelslike);
      }
      if ($windMain) { $windMain.textContent = `${label}`; tick($windMain); }
      if ($windSub) { $windSub.innerHTML = `<em>${Math.round(ws)} mph${typeof wg === 'number' ? ` (gusts ${Math.round(wg)} mph)` : ''}</em>`; tick($windSub); }

      if ($advice) { $advice.textContent = wearAdvice(t); $advice.classList.remove('skeleton'); tick($advice); }
      if ($season) { $season.textContent = seasonLabel(); tick($season); }

      // Icons
      const windIconEl = document.getElementById('windIcon');
      if (windIconEl) windIconEl.innerHTML = WIND_SVG;
      const seasonIconEl = document.getElementById('seasonIcon');
      if (seasonIconEl) seasonIconEl.innerHTML = SEASON_SVG;
      const cafeIconEl = document.getElementById('cafeIcon');
      if (cafeIconEl) cafeIconEl.innerHTML = CAFE_SVG;
      const artIconEl = document.getElementById('artIcon');
      if (artIconEl) artIconEl.innerHTML = ART_SVG;
      const precipIconEl = document.getElementById('precipIcon');
      if (precipIconEl) precipIconEl.innerHTML = CLEAR_SVG;

      // Cafe of the day — live endpoint (optional) then fallback
      try {
        let cafes = null;
        if (window.CAFES_ENDPOINT) {
          const cr = await fetch(window.CAFES_ENDPOINT);
          if (cr.ok) {
            cafes = await cr.json();
          }
        }
        const pool = Array.isArray(cafes) && cafes.length ? cafes : CAFES_STATIC;
        const pick = pickDaily(pool);
        const $cafe = document.getElementById('cafe');
        if ($cafe && pick) {
          const safeName = String(pick.name || 'cafe').toLowerCase();
          const rating = typeof pick.rating === 'number' ? ` <span class="rating">★ ${pick.rating.toFixed(1)}</span>` : '';
          const url = pick.url || `https://www.google.com/maps/search/${encodeURIComponent(safeName + ' near Central Park NYC')}`;
          $cafe.innerHTML = `<a href="${url}" target="_blank" rel="noopener noreferrer">${safeName}</a>${rating}`;
          tick($cafe);
        }
      } catch (e) {
        console.warn('cafe load failed', e);
      }

      if (sunrise && sunset) {
        const now = new Date();
        const sr = parseLocalIso(sunrise);
        const ss = parseLocalIso(sunset);
        const ms = 60 * 1000;
        const GOLDEN_MIN = 60; // ±60 minutes of sunrise/sunset
        const diffToSR = Math.abs(now - sr) / ms;
        const diffToSS = Math.abs(now - ss) / ms;
        const dark = now < sr || now > ss;
        const golden = !dark && (diffToSR <= GOLDEN_MIN || diffToSS <= GOLDEN_MIN);
        // Only apply night-bg when in auto mode (no manual override)
        if(getTheme() === 'auto') document.body.classList.toggle('night', dark);
        const iconEl = document.getElementById('sunIcon');
        if (iconEl) iconEl.innerHTML = dark ? MOON_SVG : (golden ? SUN_HORIZON_SVG : SUN_HORIZON_SVG);
        if ($sunlight) { $sunlight.textContent = dark
          ? "it’s currently dark, you should bring a light"
          : (golden ? (diffToSR <= GOLDEN_MIN ? "here comes the sun doo do doo do" : "golden hour right now") : "it’s daylight right now"); tick($sunlight); }
      } else {
        const iconEl = document.getElementById('sunIcon');
        if (iconEl) iconEl.innerHTML = SUN_HORIZON_SVG;
        if ($sunlight) { $sunlight.textContent = '—'; tick($sunlight); }
            
    }

    // compute precip nowcast after sunlight logic
    updatePrecipNowcast(new Date(), htime, hrain, hsnow, hprec, hprob, hcode);

    } catch (err) {
      console.error(err);
      if ($temp) $temp.textContent = '—';
      if ($windMain) $windMain.textContent = '—';
      if ($windSub) $windSub.innerHTML = '<em>—</em>';
      if ($advice) $advice.textContent = '—';
      if ($season) $season.textContent = '—';
      if ($sunlight) $sunlight.textContent = '—';
    } finally {
      $advice && $advice.classList.remove('skeleton');
      $windMain && $windMain.classList.remove('skeleton');
      $windSub && $windSub.classList.remove('skeleton');
      setLoading(false);
    }
  }

  // Pick art of the day (deterministic per day)
  (function loadArt(){
    try {
      const $art = document.getElementById('art');
      if (!$art) return;
      const pool = ART_STATIC;
      if (!Array.isArray(pool) || !pool.length) return;
      const idx = (daySeed(new Date()) + 13) % pool.length; // offset so it differs from cafe
      const item = pool[idx];
      const text = item.name;
      const href = item.url || `https://www.google.com/search?q=${encodeURIComponent(item.name + ' central park')}`;
      $art.innerHTML = `<a href="${href}" target="_blank" rel="noopener noreferrer">${text}</a>`;
      tick($art);
    } catch (e) { console.warn('art load failed', e); }
  })()

  if ($refresh) $refresh.addEventListener('click', load);
  if ($themeToggle) {
    $themeToggle.addEventListener('click', toggleTheme);
    $themeToggle.addEventListener('contextmenu', (e)=>{ e.preventDefault(); resetAutoTheme(); });
  }
  // initialize theme
  setTheme(getTheme());
  load();

  // Tiny self-test (logs only)
  (function selfTest(){
    const missing = [];
    if(!$temp) missing.push('#temp');
    if(!$windMain) missing.push('#windMain');
    if(!$windSub) missing.push('#windSub');
    if(!$advice) missing.push('#advice');
    if(!$season) missing.push('#season');
    if(!$sunlight) missing.push('#sunlight');
    if(!$when) missing.push('#when');
    if(!$refresh) missing.push('#refreshBtn');
    if(!$themeToggle) missing.push('#themeToggle');
    if(missing.length) console.warn('Missing elements:', missing.join(', '));

    // theme sanity
    console.assert(typeof setTheme === 'function' && typeof toggleTheme === 'function', 'theme functions missing');
    console.assert(!!document.getElementById('themeToggle'), '#themeToggle missing');

    // simple runtime tests to catch API shape regressions (non-fatal)
    console.assert(typeof NYC.lat === 'number' && typeof NYC.lon === 'number', 'NYC coords invalid');
    console.assert(typeof wearAdvice(45) === 'string', 'wearAdvice should return string');
    console.assert(['light','moderate','breezy','blustery','gusty','bitter'].some(k => (windLabel(10,55)).includes(k)), 'windLabel unexpected');

    // formatWhen shape tests (deterministic)
    const demo = new Date('2025-11-05T05:38:00Z');
    const s = formatWhen(demo);
    console.assert(/\bat\b/.test(s), 'formatWhen should include " at "');
    console.assert(s === s.toLowerCase(), 'formatWhen should be lowercase');
    console.assert(/^(monday|tuesday|wednesday|thursday|friday|saturday|sunday),\s[a-z]{3}\s\d{1,2}\sat\s\d{1,2}:\d{2}\s(am|pm)$/.test(s), 'formatWhen pattern mismatch');

    // theme tests
    const prev = getTheme();
    setTheme('light'); console.assert(document.documentElement.classList.contains('theme-light'), 'theme-light not applied');
    setTheme('dark'); console.assert(document.documentElement.classList.contains('theme-dark'), 'theme-dark not applied');
    setTheme(prev);
  })();
  </script>
</body>
</html>